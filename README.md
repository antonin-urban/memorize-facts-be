# Memorize facts backend

**Memorize facts backend** is a KeystoneJS backend for **Memorize facts** application used for backing up client's data to cloud.

This project uses:
  - [KeystoneJS](https://keystonejs.com/) + its own internal dependencies
  - [TypeScript](https://www.typescriptlang.org/)
  - [Yarn](https://yarnpkg.com/)
  - [ESLint](https://eslint.org/)
  - [Prettier](https://prettier.io/)
  - [Jest](https://jestjs.io/)
  - [Docker](https://www.docker.com/)
  - [Github Actions](https://github.com/features/actions)
  - [Semantic Release](https://github.com/semantic-release/semantic-release)

As data storage, Keystone uses [PostgreSQL](https://www.postgresql.org/).

## Installation

Prerequisites:
- Yarn
- Node.js@16.14
- Docker (optional; for local development and testing)

Installing dependencies:
```
yarn install
```

## How to run
### Local development and testing

#### Database
For local development and testing, you can use Docker image in the root of the repository.
```
docker-compose --file local-dev.yml up
```
This will create two Docker containers:
- **mf-postgres-dev** - postgres container for running project locally and for testing
- **mf-adminer** - database administration tool for viewing and managing databases
  - for `mf-postgres-dev` auth info, see `docker-compose.yml` file (`environment` section)
If you want to run DB locally, you can look to **Production** section below for more details.

#### Development run
Running project locally in development enviroment (no need to build fist):
```
yarn dev
```

#### Testing
Running build, lint and tests:
```
yarn test
```
Running only tests:
```
yarn test-only
```

### Production

#### Database
For production run, you need to set up environment variables:
```
DATABASE_URL=postgres://database_user:database_password@database_host:database_port/database_name
or

DATABASE_USER
DATABASE_PASSWORD
DATABASE_PORT
DATABASE_NAME
```

#### Production run
For production run, you need to build project first using one of the following commands:
```
yarn build or yarn deploy 
```
Then you can run project:
```
yarn start
```

## How to use
After running the project:
* you can visit http://localhost:3000/ to acces `Admin UI` (KeystoneJS autogenerated administration)
* `GraphQL API endpoint` is availble on http://localhost:3000/api/graphql
* visit http://localhost:3000/api/graphql in **development enviroment** will open `GraphQL Playground`

### GraphQL authentication
To do most of operations, you need to authenticate a session:
```
mutation{
  authenticateUserWithPassword(email: "user@example.com", password:"password1234"){
    __typename
    ... on UserAuthenticationWithPasswordSuccess {
      sessionToken
    }
    ... on UserAuthenticationWithPasswordFailure {
      message
    }
  }
}
```

About user creation:
  - only admin can create new admin users
  - non-admin cannot create new users - if you want to create another user, you need to destroy current session with logged user - only empty session or admin can create new users
  - if you have empty database, you have to use `createInitialUser` mutation to create initial **admin** user
    - OR you can visit http://localhost:3000/ to set the **admin** via `Admin UI`

If you need to create a user:
```
mutation{
  createUser(data:{
    email: "new.user@example.com",
    password: "password1234"
    isAdmin: false
  })
  {
    email
  }
}
```

After authentication, you can execute CRUD operations using queries and mutations. See the documentation in GraphQL Playground about domain model and how to use it.

## License
Unlicensed